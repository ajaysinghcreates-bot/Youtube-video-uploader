name: Instagram Reels to YouTube Shorts (SEO Optimized)

on:
  schedule:
    - cron: '0 9 * * *' # Run daily at 9 AM UTC
  workflow_dispatch:
    inputs:
      instagram_url:
        description: 'Instagram Reel URL (optional - manual trigger)'
        required: false
        type: string

env:
  YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
  YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
  YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  reel-to-shorts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install --upgrade pip
          pip install --upgrade yt-dlp google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client requests beautifulsoup4 ffmpeg-python
          pip install --upgrade openai==1.51.0 whisper

      - name: Cache Whisper models
        uses: actions/cache@v3
        with:
          path: ~/.cache/whisper
          key: whisper-models

      - name: Download Instagram Reel
        id: download
        run: |
          set -e
          mkdir -p downloads
          URL="${{ github.event.inputs.instagram_url }}"
          if [ -z "$URL" ]; then
            echo "❌ No Instagram URL provided"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          yt-dlp -o "downloads/video.mp4" "$URL"
          if [ -f "downloads/video.mp4" ]; then
            echo "video_file=downloads/video.mp4" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Download failed"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Extract audio
        if: steps.download.outputs.success == 'true'
        run: |
          ffmpeg -i downloads/video.mp4 -vn -acodec mp3 downloads/audio.mp3

      - name: Generate transcript with Whisper
        if: steps.download.outputs.success == 'true'
        run: |
          python - <<EOF
          import whisper, json
          model = whisper.load_model("small")
          result = model.transcribe("downloads/audio.mp3")
          with open("downloads/transcript.json", "w", encoding="utf-8") as f:
              json.dump(result, f, indent=2, ensure_ascii=False)
          print("✅ Transcript saved")
          EOF

      - name: Generate SEO metadata with OpenAI
        if: steps.download.outputs.success == 'true'
        run: |
          python - <<EOF
          import json, os, re, openai

          with open("downloads/transcript.json", "r", encoding="utf-8") as f:
              transcript = json.load(f)

          full_text = transcript.get("text", "")

          client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

          prompt = f"""
          Based on this transcript, generate optimized YouTube Shorts metadata.

          Transcript:
          {full_text}

          Return JSON only:
          {{
            "title": "catchy short title",
            "description": "200-300 word engaging description with hashtags",
            "tags": ["tag1","tag2","tag3"]
          }}
          """

          response = client.chat.completions.create(
              model="gpt-4o-mini",
              messages=[{"role": "user", "content": prompt}],
              max_tokens=1200,
              temperature=0.7
          )

          content = response.choices[0].message.content
          match = re.search(r"\{.*\}", content, re.DOTALL)

          seo_json = {}
          if match:
              try:
                  seo_json = json.loads(match.group())
              except:
                  seo_json = {"title": "Fallback Title", "description": "Fallback Description", "tags":["shorts"]}
          else:
              seo_json = {"title": "Fallback Title", "description": "Fallback Description", "tags":["shorts"]}

          with open("downloads/seo_content.json", "w", encoding="utf-8") as f:
              json.dump(seo_json, f, indent=2)

          print("✅ SEO content generated from transcript")
          EOF

      - name: Upload to YouTube Shorts
        if: steps.download.outputs.success == 'true'
        run: |
          python - <<EOF
          import os, json, google.auth.transport.requests, google.oauth2.credentials
          from googleapiclient.discovery import build

          with open("downloads/seo_content.json", "r", encoding="utf-8") as f:
              seo = json.load(f)

          creds = google.oauth2.credentials.Credentials(
              None,
              refresh_token=os.getenv("YOUTUBE_REFRESH_TOKEN"),
              client_id=os.getenv("YOUTUBE_CLIENT_ID"),
              client_secret=os.getenv("YOUTUBE_CLIENT_SECRET"),
              token_uri="https://oauth2.googleapis.com/token"
          )

          youtube = build("youtube", "v3", credentials=creds)

          request = youtube.videos().insert(
              part="snippet,status",
              body={
                  "snippet": {
                      "title": seo["title"],
                      "description": seo["description"],
                      "tags": seo["tags"],
                      "categoryId": "22"  # People & Blogs
                  },
                  "status": {
                      "privacyStatus": "public"
                  }
              },
              media_body="downloads/video.mp4"
          )
          response = request.execute()
          print("✅ Uploaded to YouTube:", response)
          EOF
